#!/bin/csh

set echo on

e2pdb2em.py ../tteftu_with_tRNA.pdb tmp.hdf --apix=5.2 --box=64 || exit

e2proc3d.py tmp.hdf ../fmodel_structure.hdf --filter=sxTANH_LOW_PASS:cutoff_frequency=0.15:fall_off=0.2 || exit

e2proc3d.py tmp.hdf ../model_structure.hdf --filter=sxTANH_LOW_PASS:cutoff_frequency=0.45:fall_off=0.1 || exit

rm tmp.hdf

../generate_projections.py --CTF --format="bdb"  || exit

e2boxer.py --method=Gauss -A cmd -B 64 --write_box_images --var --do_ctf --ctf_cs=2 --ctf_fstart=75 --ctf_fstop=1 --ctf_ampcont=10 --ctf_volt=120 --pix_in=5.2 --pix_out=5.2 --ccf_lo=1.14 --ccf_hi=5.0 --outformat=bdb --out_file=bdb:data2 mic*.hdf --force || exit

# Reference-free alignment of the entire 2D dataset
sxali2d_c.py bdb:data ali2d_c --ou=30 --xr=3 --yr=3 --ts=1 --maxit=5 --CTF || exit

# K-mean clustering of the 2D dataset
sxk_means.py bdb:data Kmeans --K=12 --trials=3 --opt_method=cla --maxit=100 --rand_seed=10 --CTF || exit

# Multireference alignment of the 2D dataset
sxali2d_m.py bdb:data Kmeans/averages.hdf ali2d_m --ou=30 --xr=3 --yr=3 --ts=1 --center=1 --maxit=5 --function="ref_ali2d_m" --rand_seed=10 --CTF || exit

# Determination of the initial structure using class averages and a reference structure
sxheader.py ali2d_m/multi_ref.hdf --one --params="active"
sxheader.py ali2d_m/multi_ref.hdf --zero --params="xform.projection"
sxali3d_d.py ali2d_m/multi_ref.hdf ../fmodel_structure.hdf abinitio --ou=30 --xr='0' --ts='1' --delta='20' --maxit=1 --ref_a=P  --function=reference3 || exit

# 3D reconstruction to compute initial structure based on Euler angles determined in the previous step 
sxrecons3d_n.py ali2d_m/multi_ref.hdf ab_initio_vol.hdf || exit

# Low-pass filtration of the initial structure
e2proc3d.py ab_initio_vol.hdf ab_initio_volf.hdf --filter=sxTANH_LOW_PASS:cutoff_frequency=0.15:fall_off=0.2 || exit

# 2D alignment parameters are transformed to 3D alignment parameters
sxparams_2D_to_3D.py bdb:data || exit

# 3D projection alignment - refinement of the initial structure
sxali3d_d.py bdb:data ../fmodel_structure.hdf ali3d_d --ou=30 --xr='2.0 1.0 0.5' --ts='1.0 1 0.5' --delta='31 10 2' --an='-1 12 6' --maxit=2 --ref_a=P  --function=reference3 --CTF || exit

# Refinement of the 3D structure using high accuracy alignment
sxali3d_e.py bdb:data ali3d_e --ou=30 --delta=2 --maxit=1 --chunk=0.25 --function=reference4 --CTF --debug || exit

# bootstrap calculation
sxbootstrap_bigdisk.py bdb:data wgts.txt bootstrap bootstrap/tmpslice --calcwgts --delta=40 || exit

# bootstrap calculation
sxbootstrap_bigdisk.py bdb:data wgts.txt bootstrap bootstrap/tmpslice --niter=10 --nbufvol=5 --seedbase=10000 --snr=1.0 --genbuf --sharebuf  || exit

# Compute real-space variance
sxdefvar.py bootstrap/bsvol000*.hdf defvar --fl=0.16 --fh=0.20 --radccc=24 || exit

# generate reference volume using average volume and variance
../generate_refvols.py defvar/avg.hdf defvar/var.hdf 88.0

# 3D multi reference alignment
sxali3d_m.py bdb:data rem.hdf ali3d_m --ou=30 --xr='4' --ts='2' --delta='15' --center=1 --nassign=3 --nrefine=1 --ref_a=P --CTF


